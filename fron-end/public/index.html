<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MGIMSS</title>
    <!--
      manifest.json provides metadata used when your web app is added to the
      homescreen on Android. See https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json">
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico">

    <link href="./style.css">
    <!--<link rel="stylesheet" type="text/css" href="css/reset.css"/>-->
    <!--<link rel="stylesheet" href="bootstrap/css/bootstrap.css">-->
    <!--<link rel="stylesheet" type="text/css" href="css/willesPlay.css"/>-->
    <!--<script src="%PUBLIC_URL%/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>-->
    <!--<script src="js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>-->
    <script src="js/willesPlay.js" type="text/javascript" charset="utf-8"></script>
    <!--<script src="%PUBLIC_URL%/js/willesPlay.js" type="text/javascript" charset="utf-8"></script>-->
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->

    <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn-hangzhou.goeasy.io/goeasy.js"></script>
    <script type="text/javascript">
      let goEasy = new GoEasy({
        appkey: 'BS-a877d9d456a5459f982c7dfef47f42d0'
      });
      goEasy.subscribe({
        channel: 'MGIMSS',
        onMessage: function(message){

          let popNotice = function() {
            if (Notification.permission === "granted") {
              let notification = new Notification("Hi ：", {
                body: message.content,
              });
              notification.onclick = function() {
                notification.close();
              };
            }
          };

          if (Notification.permission === "granted") {
            popNotice();
          } else if (Notification.permission !== "denied") {
            Notification.requestPermission(function (permission) {
              popNotice();
            });
          }

        }});
    </script>

  </head>

  <!-- BODY options, add following classes to body to change options

  // Header options
  1. '.header-fixed'					- Fixed Header

  // Brand options
  1. '.brand-minimized'       - Minimized brand (Only symbol)

  // Sidebar options
  1. '.sidebar-fixed'					- Fixed Sidebar
  2. '.sidebar-hidden'				- Hidden Sidebar
  3. '.sidebar-off-canvas'		- Off Canvas Sidebar
  4. '.sidebar-minimized'			- Minimized Sidebar (Only icons)
  5. '.sidebar-compact'			  - Compact Sidebar

  // Aside options
  1. '.aside-menu-fixed'			- Fixed Aside Menu
  2. '.aside-menu-hidden'			- Hidden Aside Menu
  3. '.aside-menu-off-canvas'	- Off Canvas Aside Menu

  // Breadcrumb options
  1. '.breadcrumb-fixed'			- Fixed Breadcrumb

  // Footer options
  1. '.footer-fixed'					- Fixed footer

  -->

  <body>
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>
    <div id="root"></div>
    <video width="100%" height="100%" id="video" style="display:none">
    </video>
    <script>
      var playVideo = document.getElementById("video");
      playVideo.muted=true;
      console.log(playVideo)
    </script>
    <div id="KeFuDiv" class="KeFuDiv" onmousedown="MoveDiv(KeFuDiv,event);">
      <img id = "luyin" src="%PUBLIC_URL%/luyin.jpg" class="img-circle" height="70px" width="70px" onmousedown="startRecording()" onmouseup="stopRecord()">
      <!--<a href='#' onmousedown="startRecording()" onmouseup="stopRecord()"><span>录音</span></a>-->
      <!--<a href='#'onClick="stopRecord()"><span>识别语音</span></a>-->
    </div><!--KeFuDiv end-->

    <script type="text/javascript" src="http://7xnlea.com2.z0.glb.qiniucdn.com/online.js"></script>
    <script type="text/javascript">
      //初始位置
      gID("KeFuDiv").style.top = (document.documentElement.clientHeight - gID("KeFuDiv").offsetHeight)/2 +"px";
      gID("KeFuDiv").style.right = document.documentElement.clientWidth - gID("KeFuDiv").offsetWidth +"px";
      //开始滚动
      ScrollDiv('KeFuDiv');
    </script>
    <style>
      .KeFuDiv{position:absolute;height:80px;width:80px;color:#fff;font-size:20px;text-align: center;cursor: pointer;}
      .KeFuDiv p{line-height: 80px;font-weight:bold;}
    </style>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
  <script>

    (function (window) {
      //兼容
      window.URL = window.URL || window.webkitURL;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

      var HZRecorder = function (stream, config) {
        config = config || {};

        config.sampleBits = config.sampleBits || 8;      //采样数位 8, 16
        config.sampleRate = config.sampleRate || (44100 / 6);   //采样率(1/6 44100)
        console.log(config.sampleBits);
        console.log("config.sampleBits");
        console.log(config.sampleRate);
        console.log("config.sampleRate");
        var video = document.getElementById("video");
        video.src = window.URL.createObjectURL(stream);
        video.onloadedmetadata = function(e) {
          console.log('nihao44eee4aaaaddda');
          video.play();
        };
        //创建一个音频环境对象
        audioContext = window.AudioContext || window.webkitAudioContext;
        var context = new audioContext();

        //将声音输入这个对像
        var audioInput = context.createMediaStreamSource(stream);

        //设置音量节点
        var volume = context.createGain();
        audioInput.connect(volume);

        //创建缓存，用来缓存声音
        var bufferSize = 4096;

        // 创建声音的缓存节点，createScriptProcessor方法的
        // 第二个和第三个参数指的是输入和输出都是双声道。
        var recorder = context.createScriptProcessor(bufferSize, 2, 2);

        var audioData = {
          size: 0          //录音文件长度
          , buffer: []     //录音缓存
          , inputSampleRate: 44100   //输入采样率
          , inputSampleBits: 16       //输入采样数位 8, 16
          , outputSampleRate: 13800   //输出采样率
          ,oututSampleBits: 16     //输出采样数位 8, 16
          , input: function (data) {
            this.buffer.push(new Float32Array(data));
            this.size += data.length;
          }
          , compress: function () { //合并压缩
            //合并
            var data = new Float32Array(this.size);
            var offset = 0;
            for (var i = 0; i < this.buffer.length; i++) {
              data.set(this.buffer[i], offset);
              offset += this.buffer[i].length;
            }
            console.log(data);
            //压缩
            var compression = parseInt(this.inputSampleRate / this.outputSampleRate);

            var length = data.length / compression;
            var result = new Float32Array(length);
            var index = 0, j = 0;
            while (index < length) {
              result[index] = data[j];
              j += compression;
              index++;
            }
            return result;
          }
          , encodeWAV: function () {
            var sampleRate = Math.min(this.inputSampleRate, this.outputSampleRate);
            var sampleBits = Math.min(this.inputSampleBits, this.oututSampleBits);
            var bytes = this.compress();
            var dataLength = bytes.length * (sampleBits / 8);
            var buffer = new ArrayBuffer(44 + dataLength);
            var data = new DataView(buffer);

            var channelCount = 1;//单声道
            var offset = 0;

            var writeString = function (str) {
              for (var i = 0; i < str.length; i++) {
                data.setUint8(offset + i, str.charCodeAt(i));
              }
            };

            // 资源交换文件标识符
            writeString('RIFF'); offset += 4;
            // 下个地址开始到文件尾总字节数,即文件大小-8
            data.setUint32(offset, 36 + dataLength, true); offset += 4;
            // WAV文件标志
            writeString('WAVE'); offset += 4;
            // 波形格式标志
            writeString('fmt '); offset += 4;
            // 过滤字节,一般为 0x10 = 16
            data.setUint32(offset, 16, true); offset += 4;
            // 格式类别 (PCM形式采样数据)
            data.setUint16(offset, 1, true); offset += 2;
            // 通道数
            data.setUint16(offset, channelCount, true); offset += 2;
            // 采样率,每秒样本数,表示每个通道的播放速度
            data.setUint32(offset, sampleRate, true); offset += 4;
            // 波形数据传输率 (每秒平均字节数) 单声道×每秒数据位数×每样本数据位/8
            data.setUint32(offset, channelCount * sampleRate * (sampleBits / 8), true); offset += 4;
            // 快数据调整数 采样一次占用字节数 单声道×每样本的数据位数/8
            data.setUint16(offset, channelCount * (sampleBits / 8), true); offset += 2;
            // 每样本数据位数
            data.setUint16(offset, sampleBits, true); offset += 2;
            // 数据标识符
            writeString('data'); offset += 4;
            // 采样数据总数,即数据总大小-44
            data.setUint32(offset, dataLength, true); offset += 4;
            // 写入采样数据
            if (sampleBits === 8) {
              for (var i = 0; i < bytes.length; i++, offset++) {
                var s = Math.max(-1, Math.min(1, bytes[i]));
                var val = s < 0 ? s * 0x8000 : s * 0x7FFF;
                val = parseInt(255 / (65535 / (val + 32768)));
                data.setInt8(offset, val, true);
              }
            } else {
              for (var i = 0; i < bytes.length; i++, offset += 2) {
                var s = Math.max(-1, Math.min(1, bytes[i]));
                data.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
              }
            }

            return new Blob([data], { type: 'audio/wav' });
          }
        };
        console.log("采样率");
        console.log(audioData);

        //开始录音
        this.start = function () {
          audioInput.connect(recorder);
          recorder.connect(context.destination);
        };
        this.close = function () {
          context.close();
        };
        //停止
        this.stop = function () {
          recorder.disconnect();
        };

        //获取音频文件
        this.getBlob = function () {
          this.stop();
          return audioData.encodeWAV();
        };

        //回放
        this.play = function (audio) {
          audio.src = window.URL.createObjectURL(this.getBlob());
        };

        //上传
        this.upload = function (url, callback) {
          var fd = new FormData();
          fd.append('audioData', this.getBlob());
          var xhr = new XMLHttpRequest();
          if (callback) {
            xhr.upload.addEventListener('progress', function (e) {
              callback('uploading', e);
            }, false);
            xhr.addEventListener('load', function (e) {
              callback('ok', e);
            }, false);
            xhr.addEventListener('error', function (e) {
              callback('error', e);
            }, false);
            xhr.addEventListener('abort', function (e) {
              callback('cancel', e);
            }, false);
          }
          xhr.open('POST', url);
          xhr.send(fd);
        };

        //音频采集
        recorder.onaudioprocess = function (e) {
          audioData.input(e.inputBuffer.getChannelData(0));
          //record(e.inputBuffer.getChannelData(0));
        };

      };
      //抛出异常
      HZRecorder.throwError = function (message) {
        throw new function () { this.toString = function () { return message; };};
      };
      //是否支持录音
      HZRecorder.canRecording = (navigator.getUserMedia != null);
      //获取录音机
      HZRecorder.get = function (callback, config) {
        if (callback) {
          if (navigator.getUserMedia) {
            navigator.getUserMedia(
              { audio: true } //只启用音频
              , function (stream) {
                var rec = new HZRecorder(stream, config);
                callback(rec);
              }
              , function (error) {
                switch (error.code || error.name) {
                  case 'PERMISSION_DENIED':
                  case 'PermissionDeniedError':
                    HZRecorder.throwError('用户拒绝提供信息。');
                    break;
                  case 'NOT_SUPPORTED_ERROR':
                  case 'NotSupportedError':
                    HZRecorder.throwError('<a href="http://www.it165.net/edu/ewl/" target="_blank" class="keylink">浏览器</a>不支持硬件设备。');
                    break;
                  case 'MANDATORY_UNSATISFIED_ERROR':
                  case 'MandatoryUnsatisfiedError':
                    HZRecorder.throwError('无法发现指定的硬件设备。');
                    break;
                  default:
                    HZRecorder.throwError('无法打开麦克风。异常信息:' + (error.code || error.name));
                    break;
                }
              });
          } else {
            HZRecorder.throwErr('当前<a href="http://www.it165.net/edu/ewl/" target="_blank" class="keylink">浏览器</a>不支持录音功能。'); return;
          }
        }
      };
      HZRecorder.get2 = function (callback, config) {
        if (callback) {
          if (navigator.getUserMedia) {
            navigator.getUserMedia(
              { audio: true , video: { width: 320, height: 320 }} //只启用音频
              , function (stream) {
                var rec = new HZRecorder(stream, config);
                callback(rec);
              }
              , function (error) {
                switch (error.code || error.name) {
                  case 'PERMISSION_DENIED':
                  case 'PermissionDeniedError':
                    HZRecorder.throwError('用户拒绝提供信息。');
                    break;
                  case 'NOT_SUPPORTED_ERROR':
                  case 'NotSupportedError':
                    HZRecorder.throwError('<a href="http://www.it165.net/edu/ewl/" target="_blank" class="keylink">浏览器</a>不支持硬件设备。');
                    break;
                  case 'MANDATORY_UNSATISFIED_ERROR':
                  case 'MandatoryUnsatisfiedError':
                    HZRecorder.throwError('无法发现指定的硬件设备。');
                    break;
                  default:
                    HZRecorder.throwError('无法打开麦克风。异常信息:' + (error.code || error.name));
                    break;
                }
              });
          } else {
            HZRecorder.throwErr('当前<a href="http://www.it165.net/edu/ewl/" target="_blank" class="keylink">浏览器</a>不支持录音功能。'); return;
          }
        }
      };
      window.HZRecorder = HZRecorder;

    })(window);




    /* 音频 */
    var recorder;
    var audio = document.querySelector('audio');

    function changeluyin1() {
      var img = document.getElementById("luyin");
      img.src="%PUBLIC_URL%/luyin2.gif";
    }

    function changeluyin2() {
      var img = document.getElementById("luyin");
      img.src="%PUBLIC_URL%/luyin.jpg";
    }
    function startRecording() {
      var img = document.getElementById("luyin");
      img.src="%PUBLIC_URL%/luyin2.gif";
      HZRecorder.get(function (rec) {
        recorder = rec;
        recorder.start();
      });
    }
    function startRecording2() {
      HZRecorder.get2(function (rec) {
        recorder = rec;
        recorder.start();
      });
      var num=10;
      var interval=setInterval(function(){
        if(num==0){
          document.getElementById("picture").click();
          console.log("click");
          clearInterval(interval);
        }
        numDiv.innerHTML=num--;
      },1000);

    }


    function obtainRecord(){
      var img = document.getElementById("luyin");
      img.src="%PUBLIC_URL%/luyin.jpg";
      var record = recorder.getBlob();
      var reader = new FileReader();
      reader.readAsDataURL(record);
      reader.onload = function () {
        console.log(reader.result);
        ans = reader.result;
        var xmlhttp;
        if (window.XMLHttpRequest)
        {
          //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
          xmlhttp=new XMLHttpRequest();
        }
        xmlhttp.onreadystatechange=function()
        {
          if (xmlhttp.readyState==4 && xmlhttp.status==200)
          {
          }
        }

        xmlhttp.open("POST","/webSpeech",true);
        xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        xmlhttp.send("sudio="+ans);
      };
      recorder.close();
    };

    function stopRecord(){
      var img = document.getElementById("luyin");
      img.src="%PUBLIC_URL%/luyin.jpg";
      recorder.stop();
      var record = recorder.getBlob();
      var reader = new FileReader();
      reader.readAsDataURL(record);
      reader.onload = function () {
        console.log(reader.result);
        ans = reader.result;
        var xmlhttp;
        if (window.XMLHttpRequest)
        {
          //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
          xmlhttp=new XMLHttpRequest();
        }
        xmlhttp.onreadystatechange=function()
        {
          if (xmlhttp.readyState==4 && xmlhttp.status==200)
          {
          }
        }

        xmlhttp.open("POST","/webSpeech",true);
        xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        xmlhttp.send("sudio="+ans);
      };
      recorder.close();
    };

    function playRecord(){
      recorder.play(audio);
    };


  </script>
</html>
